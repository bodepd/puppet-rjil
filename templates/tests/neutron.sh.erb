#!/bin/bash
set -e
function fail {
  echo "CRITICAL: $@"
  exit 2
}


if [ -f /root/openrc ]; then
  source /root/openrc
  netname=testnet<%= @net_number %>
  neutron net-list -D || fail 'neutron net-list failed'
  neutron net-create $netname || fail 'neutron net-create failed'
  netid=`neutron net-list -D | grep $netname |  awk '/[a-z][a-z]*[0-9][0-9]*/ {print $2}' | head -1`
  neutron subnet-create $netid 10.0.0.0/24 || fail 'neutron subnet-create failed'
  neutron port-create $netid || fail 'neutron port-create failed'
  for port in `neutron port-list | awk '/[a-z][a-z]*[0-9][0-9]*/ {print $2}'`; do
    neutron port-delete $port || true
  done
  for net in `neutron net-list -D  | awk '/[a-z][a-z]*[0-9][0-9]*/ {print $2}'`; do
    neutron net-delete $net || true
  done
else
  echo 'Critical: Openrc does not exist'
  exit 2
fi
